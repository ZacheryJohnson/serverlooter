use std::sync::{Arc, Mutex};
use bevy::prelude::Commands;
use bevy_egui::egui;
use bevy_egui::egui::{Context, Ui};
use crate::{lock_and_clone, ExploitTarget, PlayerState};
use crate::event::request_start_exploit::RequestStartExploitEvent;
use crate::script::Script;
use crate::server::Server;
use crate::ui::hover_text::OnHoverText;
use crate::ui::panel::Panel;

pub struct ExploitPanel {
    pub selected_exploit_target: Option<Arc<Mutex<ExploitTarget>>>,
    pub selected_script: Option<Arc<Mutex<Script>>>,
    pub selected_server: Option<Arc<Mutex<Server>>>,
}

impl ExploitPanel {
    pub fn new() -> Self {
        ExploitPanel {
            selected_exploit_target: None,
            selected_script: None,
            selected_server: None,
        }
    }
}

impl Panel for ExploitPanel {
    fn update(
        &mut self,
        commands: &mut Commands,
        _: &Context,
        ui: &mut Ui,
        player_state: &PlayerState)
    {
        ui.heading("Targets");
        ui.horizontal(|ui| {
            for exploit_target in &player_state.known_targets {
                let exploit_target_id = exploit_target.lock().unwrap().id;
                let is_selected = match self.selected_exploit_target {
                    Some(ref target) => target.lock().unwrap().id == exploit_target_id,
                    None => false,
                };
                if ui.selectable_label(is_selected, format!("{}", lock_and_clone!(exploit_target, server, name))).clicked() {
                    self.selected_exploit_target = Some(exploit_target.to_owned());
                }
            }
        });

        ui.separator();
        ui.heading("Script");
        let empty_script = Arc::new(Mutex::new(Script::empty()));
        let selected_script = self.selected_script.as_ref().unwrap_or(&empty_script);
        let selected_script = selected_script.clone();
        egui::ComboBox::from_id_salt("scripts")
            .selected_text(format!("{}", selected_script.lock().unwrap().id))
            .show_ui(ui, |ui| {
                let mut selected_script_id = selected_script.lock().unwrap().id.clone();
                for script in &player_state.scripts {
                    let script_id = script.lock().unwrap().id.clone();
                    let selectable_value = ui.selectable_value(
                        &mut selected_script_id,
                        script_id.clone(),
                        format!("{script_id}")
                    );

                    selectable_value.on_hover_ui(|ui| {
                        let script_inner = script.lock().unwrap();
                        let hover_text = script_inner.on_hover_text(&());

                        ui.label(hover_text);
                    });

                    if selected_script_id == script_id {
                        self.selected_script = Some(script.clone());
                    }
                }
            });

        // ZJ-TODO: server selection
        ui.separator();
        ui.heading("Server");
        let empty_server = Arc::new(Mutex::new(Server::empty()));
        let selected_server = self.selected_server.as_ref().unwrap_or(&empty_server);
        let selected_server = selected_server.clone();
        egui::ComboBox::from_id_salt("servers")
            .selected_text(format!("{}", selected_server.lock().unwrap().name))
            .show_ui(ui, |ui| {
                let mut selected_server_name = selected_server.lock().unwrap().name.clone();
                for server in &player_state.servers {
                    let server_name = server.lock().unwrap().name.clone();
                    ui.selectable_value(
                        &mut selected_server_name,
                        server_name.clone(),
                        format!("{server_name}")
                    );

                    if selected_server_name == server_name {
                        self.selected_server = Some(server.clone());
                    }
                }
            });

        ui.separator();
        let required_fields_set = self.selected_exploit_target.is_some() && self.selected_script.is_some();
        if ui.add_enabled(required_fields_set, egui::Button::new("Run")).clicked() {
            commands.trigger(RequestStartExploitEvent {
                target: self.selected_exploit_target.as_ref().unwrap().clone(),
                script: self.selected_script.as_ref().unwrap().clone(),
                server: self.selected_server.as_ref().unwrap().clone(),
            });

            self.selected_exploit_target = None;
            self.selected_script = None;
            self.selected_server = None;
        }
    }
}